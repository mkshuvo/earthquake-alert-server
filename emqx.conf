# EMQX Configuration for Earthquake Detection System
# Professional production setup with clustering, TLS, and authentication

## Node Configuration
node {
  name = "emqx@emqx"
  data_dir = "/opt/emqx/data"
}

## Cluster Configuration
cluster {
  discovery_strategy = static
  static {
    seeds = ["emqx@emqx"]
  }
}

## MQTT Core Settings
mqtt {
  # Maximum packet size (1MB for earthquake sensor data)
  max_packet_size = "1MB"
  
  # Client ID settings
  clientid_prefix = ""
  
  # Keepalive configuration
  keepalive_interval = "60s"
  
  # QoS settings
  max_qos_allowed = 2
  max_inflight = 32
  
  # Subscription settings
  max_topic_levels = 10
  max_subscriptions_per_client = 1000
  
  # Retain settings for critical alerts
  retain_available = true
  max_retained_messages = 10000
  
  # Session settings
  session_expiry_interval = "7200s"  # 2 hours
  
  # Topic alias settings
  topic_alias_maximum = 65535
}

## MQTT Topic Configuration
topic_settings {
  # Enable system topic for monitoring
  system_topic = true
  
  # System topic broadcast interval
  system_event_messages {
    client_connected = true
    client_disconnected = true
    client_subscribed = true
    client_unsubscribed = true
  }
}

## Listeners (Network Configuration)

# MQTT TCP Listener (internal, no auth for internal services)
listeners.tcp.default {
  bind = "0.0.0.0:1883"
  acceptors = 32
  max_connections = 1000000
  mountpoint = ""
  proxy_protocol = false
  proxy_protocol_timeout = "3s"
  enable_stats = true
  
  # TCP keepalive
  tcp_opts {
    backlog = 1024
    send_timeout = "15s"
    send_timeout_close = true
    recbuf = 2MB
    sndbuf = 2MB
    buffer_type = "binary"
    nodelay = true
    reuseaddr = true
  }
}

# MQTT TLS Listener (encrypted, for external connections)
listeners.ssl.default {
  bind = "0.0.0.0:8883"
  acceptors = 32
  max_connections = 1000000
  mountpoint = ""
  proxy_protocol = false
  proxy_protocol_timeout = "3s"
  enable_stats = true
  
  # TLS Configuration (easily replaceable)
  ssl_opts {
    keyfile = "/opt/emqx/etc/certs/server-key.pem"
    certfile = "/opt/emqx/etc/certs/server-cert.pem"
    cacertfile = "/opt/emqx/etc/certs/ca-cert.pem"
    
    # TLS version and cipher settings
    versions = ["tlsv1.2", "tlsv1.3"]
    ciphers = [
      "TLS_AES_256_GCM_SHA384",
      "TLS_CHACHA20_POLY1305_SHA256",
      "TLS_AES_128_GCM_SHA256",
      "ECDHE-RSA-AES256-GCM-SHA384",
      "ECDHE-RSA-CHACHA20-POLY1305",
      "ECDHE-RSA-AES128-GCM-SHA256"
    ]
    
    # Client certificate verification (optional - set to required for mutual TLS)
    verify = optional
    fail_if_no_peer_cert = false
    
    # Session settings
    session_tickets = auto
    session_timeout = "8h"
  }
  
  # TCP options
  tcp_opts {
    backlog = 1024
    send_timeout = "15s"
    send_timeout_close = true
    recbuf = 2MB
    sndbuf = 2MB
    buffer_type = "binary"
    nodelay = true
    reuseaddr = true
  }
}

# WebSocket Listener (for web clients)
listeners.ws.default {
  bind = "0.0.0.0:8083"
  acceptors = 32
  max_connections = 1000000
  mountpoint = ""
  piggyback = multiple
  enable_stats = true
  
  websocket {
    path = "/mqtt"
    piggyback = multiple
  }
  
  tcp_opts {
    backlog = 1024
    send_timeout = "15s"
    send_timeout_close = true
    recbuf = 2MB
    sndbuf = 2MB
    buffer_type = "binary"
    nodelay = true
    reuseaddr = true
  }
}

# WebSocket Secure Listener (for encrypted web clients)
listeners.wss.default {
  bind = "0.0.0.0:8084"
  acceptors = 32
  max_connections = 1000000
  mountpoint = ""
  piggyback = multiple
  enable_stats = true
  
  websocket {
    path = "/mqtt"
    piggyback = multiple
  }
  
  ssl_opts {
    keyfile = "/opt/emqx/etc/certs/server-key.pem"
    certfile = "/opt/emqx/etc/certs/server-cert.pem"
    cacertfile = "/opt/emqx/etc/certs/ca-cert.pem"
    
    versions = ["tlsv1.2", "tlsv1.3"]
    ciphers = [
      "TLS_AES_256_GCM_SHA384",
      "TLS_CHACHA20_POLY1305_SHA256",
      "TLS_AES_128_GCM_SHA256",
      "ECDHE-RSA-AES256-GCM-SHA384",
      "ECDHE-RSA-CHACHA20-POLY1305",
      "ECDHE-RSA-AES128-GCM-SHA256"
    ]
    
    verify = optional
    fail_if_no_peer_cert = false
  }
  
  tcp_opts {
    backlog = 1024
    send_timeout = "15s"
    send_timeout_close = true
    recbuf = 2MB
    sndbuf = 2MB
    buffer_type = "binary"
    nodelay = true
    reuseaddr = true
  }
}

## Authentication

# Enable built-in authentication database
authentication {
  enable = true
  backend = built_in_database
  
  user {
    type = built_in_database
  }
}

## Authorization (Access Control)

authorization {
  enable = true
  
  deny_action = ignore
  
  default_permission = allow
  
  # Built-in database based ACL
  sources = [
    {
      type = built_in_database
      enable = true
    }
  ]
}

## System Settings

log {
  # Log level: debug, info, notice, warning, error
  level = "info"
  
  # Console output
  console {
    enable = true
    level = "info"
  }
  
  # File output
  file {
    enable = true
    level = "info"
    rotation {
      size = "50MB"
      count = 5
    }
  }
}

## Dashboard Configuration

dashboard {
  listeners {
    http {
      bind = "18083"
      inet6 = false
    }
  }
  
  # Default admin credentials (CHANGE IN PRODUCTION!)
  default_username = "admin"
  default_password = "public"
}

## Performance Tuning

sys_tunables {
  # Connection settings
  num_acceptors = 32
  num_conns_sups = 4
  
  # Memory settings
  tune_heap_size = true
  heap_size = "2GB"
  
  # GC settings
  fullsweep_after = 10000
  process_limit = 2097152
}

## Rate Limiting

limiter {
  client {
    connection {
      rate = "1000/s"
    }
    
    message_in {
      rate = "100/s"
    }
    
    message_publish {
      rate = "100/s"
    }
  }
}

## Message Persistence

retention {
  # Message retention settings
  messages_per_session = 100
  message_expiry_interval = "7d"
}

## Monitoring

stats {
  enable = true
}

monitoring {
  # Enable metrics collection
  prometheus_push_gateway {
    enable = false
  }
}

## Plugin Configuration

plugins {
  install_dir = "/opt/emqx/plugins"
  # Additional plugins can be loaded here
}
